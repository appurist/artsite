# Cloudflare Pages Deployment Guide

## Overview
This project has been restructured to use Cloudflare Pages with Functions instead of Workers. This provides:
- Automatic GitHub deployments
- Same-origin API calls (no CORS issues)
- Simplified configuration
- Better integration between frontend and backend

## Project Structure
```
artsite/
├── functions/               # Pages Functions (replaces workers/)
│   └── api/
│       └── [[route]].js    # Dynamic API router
├── workers/                 # Original worker code (used by functions)
├── dist/                   # Built frontend (generated by `pnpm build`)
├── public/
│   └── _routes.json        # Pages routing configuration
└── wrangler.toml           # Local dev configuration only
```

## Local Development

1. **Build the frontend:**
   ```bash
   pnpm build
   ```

2. **Start Pages development server:**
   ```bash
   pnpm dev:pages
   ```

3. **Access the application:**
   - Frontend + API: http://localhost:8788

## Cloudflare Pages Configuration

### Environment Variables (Set in CF Pages dashboard)
Production environment variables needed:
- `JWT_SECRET`
- `CLOUDFLARE_ACCOUNT_ID` 
- `CLOUDFLARE_IMAGES_TOKEN`
- `CLOUDFLARE_ACCOUNT_HASH`
- `FRONTEND_URL=https://artsite.ca`
- `EMAIL_FROM=noreply@artsite.ca`
- `ARTWORK_IMAGES_BASE_URL=https://r2.artsite.ca`

### Database Bindings
Add in CF Pages settings > Functions:
- **D1 Database**: `DB` → `artsite-prod`

### R2 Bindings  
Add in CF Pages settings > Functions:
- **R2 Bucket**: `ARTWORK_IMAGES` → `artsite-images`

## Build Configuration
For CF Pages project settings:
- **Build command**: `pnpm build`
- **Output directory**: `dist`
- **Root directory**: (leave empty)

## Deployment
Pages will automatically deploy on git push to main branch.

Manual deployment:
```bash
pnpm pages:deploy
```

## API Endpoints
All API endpoints remain the same:
- `/api/auth/*` - Authentication
- `/api/artworks/*` - Artwork management
- `/api/backup/*` - Backup/restore (including new chunked endpoints)
- `/api/profile/*` - Profile management
- `/api/settings/*` - Site settings
- `/api/upload/*` - File uploads

## Benefits of Pages vs Workers
1. **No CORS issues**: Same-origin requests
2. **Automatic deployments**: Git-based deployments
3. **Simplified config**: No complex wrangler.toml
4. **Better integration**: Frontend and backend deployed together
5. **Cost optimization**: Pages is often more cost-effective